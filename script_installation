!#/bin/bash
function red () {echo -e "\e[1;4;31m$1\e[0m"; }

red "Mise à jour du système"
sleep 10
apt update -y
apt upgrade -y
red "Installation de sudo"
apt install sudo -y
echo "Ajout de gbehra au groupe sudo"
usermod -aG sudo gbehra
echo "Vérification de l'ajout"
getent group sudo
echo "Ajout des privilèges à gbehra dans sudoers"
sed -i '/# User privilege specification/a gbehra	ALL=(ALL) ALL' /etc/sudoers
echo "installation de Vim"
apt install vim -y
echo "Vérification de la version"
vim --version
echo "Installation de openssh-server"
apt install openssh-server -y
echo "Vérification"
systemctl status ssh
echo "Changement du port 22 en 4242"
sed -i 's/^#\?Port 22$/Port 4242' /etc/ssh/sshd_config
echo "Vérification du changement"
grep Port /etc/ssh/sshd_config
echo "Redémarrage du service ssh"
service ssh restart
echo "Installation de UFW"
apt install ufw
echo "Activation ufw"
ufw enable
echo "Vérification du statut"
ufw status numbered
echo "Configuration des ports"
ufw allow ssh
ufw allow 4242
echo "Vérification des status"
ufw status numbered
echo "Redémarrage ssh"
systemctl restart ssh
echo "Vérification du statut"
service sshd status
echo "Installation de libpam-pwquality"
apt install libpam-pwquality
echo "Ajout des règles de mot de passe"
sed -i '/^password.*pam_pwquality.so retry=3/s/$/ minlen=10 ucredit=-1 lcredit=-1 dcredit=-1 maxrepeat=3 reject_username difok=7 enforce_for_root/' /etc/pam.d/common-password
echo "Mise en place de règles durée mot de passe"
sed -i 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS 30/' /etc/login.defs
sed -i 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS 2/' /etc/login.defs
sed -i 's/^PASS_WARN_AGE.*/PASS_WARN_AGE 7/' /etc/login.defs
echo "LA PREMMIERE PARTIE EST FINIE, REBOOT VM PUIS LANCER LE DEUXIEME SCRIPT"